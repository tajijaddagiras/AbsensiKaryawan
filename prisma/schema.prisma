// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String    @id @default(uuid())
  username      String    @unique
  email         String    @unique
  password      String    // Bcrypt hashed
  fullName      String    @map("full_name")
  role          String    @default("user") // 'admin' or 'user'
  phone         String?
  avatarUrl     String?   @map("avatar_url")
  isActive      Boolean   @default(true) @map("is_active")
  lastLogin     DateTime? @map("last_login")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  employee      Employee?
  reviewedLeaves LeaveRequest[] @relation("ReviewedLeaves")

  @@map("app_users")
}

model Employee {
  id              String    @id @default(uuid())
  userId          String?   @unique @map("user_id")
  employeeCode    String    @unique @map("employee_code")
  fullName        String    @map("full_name")
  email           String    @unique
  phone           String?
  department      String?
  position        String?
  hireDate        DateTime? @map("hire_date")
  isActive        Boolean   @default(true) @map("is_active")
  faceEncodingPath String?  @map("face_encoding_path")
  faceMatchScore  Decimal?  @map("face_match_score")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  user            User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendance      Attendance[]
  leaveRequests   LeaveRequest[]

  @@map("employees")
}

model OfficeLocation {
  id          String    @id @default(uuid())
  name        String
  address     String?
  latitude    Decimal
  longitude   Decimal
  radius      Int       @default(100)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  attendance  Attendance[]

  @@map("office_locations")
}

model Attendance {
  id                String    @id @default(uuid())
  employeeId        String    @map("employee_id")
  checkInTime       DateTime  @map("check_in_time")
  checkOutTime      DateTime? @map("check_out_time")
  checkInLatitude   Decimal?  @map("check_in_latitude")
  checkInLongitude  Decimal?  @map("check_in_longitude")
  checkOutLatitude  Decimal?  @map("check_out_latitude")
  checkOutLongitude Decimal?  @map("check_out_longitude")
  officeLocationId  String?   @map("office_location_id")
  status            String    @default("present") // 'present', 'late', 'absent', 'leave'
  faceMatchScore    Decimal?  @map("face_match_score")
  notes             String?
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  employee          Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  officeLocation    OfficeLocation? @relation(fields: [officeLocationId], references: [id])

  @@map("attendance")
}

model LeaveRequest {
  id            String    @id @default(uuid())
  employeeId    String    @map("employee_id")
  leaveType     String    @map("leave_type") // 'sick', 'annual', 'personal', 'emergency'
  startDate     DateTime  @map("start_date")
  endDate       DateTime  @map("end_date")
  days          Int
  reason        String
  attachmentUrl String?   @map("attachment_url")
  status        String    @default("pending") // 'pending', 'approved', 'rejected'
  adminNotes    String?   @map("admin_notes")
  reviewedBy    String?   @map("reviewed_by")
  reviewedAt    DateTime? @map("reviewed_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  reviewer      User?     @relation("ReviewedLeaves", fields: [reviewedBy], references: [id])

  @@map("leave_requests")
}

model SystemSetting {
  id           String    @id @default(uuid())
  settingKey   String    @unique @map("setting_key")
  settingValue String    @map("setting_value")
  description  String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("system_settings")
}

model WorkSchedule {
  id                  String    @id @default(uuid())
  dayOfWeek           Int       @unique @map("day_of_week") // 0=Sunday, 1=Monday...
  dayName             String    @map("day_name")
  startTime           String    @map("start_time") // Format "HH:mm"
  onTimeEndTime       String?   @map("on_time_end_time")
  toleranceStartTime  String?   @map("tolerance_start_time")
  toleranceEndTime    String?   @map("tolerance_end_time")
  endTime             String    @map("end_time")
  isActive            Boolean   @default(true) @map("is_active")
  lateToleranceMinutes Int      @default(15) @map("late_tolerance_minutes")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  @@map("work_schedules")
}

model Holiday {
  id          String    @id @default(uuid())
  name        String
  date        DateTime
  type        String    // 'national', 'company'
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("holidays")
}

model Policy {
  id          String    @id @default(uuid())
  title       String
  description String
  category    String    // 'attendance', 'leave', 'general'
  policyData  String?   @map("policy_data") // JSON string
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("policies")
}
